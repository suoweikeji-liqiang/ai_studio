# B5: åˆ†ç±»å¼æ™ºèƒ½æ¢ç´¢é¢æ¿

## éœ€æ±‚æè¿°

ä»¥åˆ†ç±»å¡ç‰‡å½¢å¼æ²‰æ·€å¸¸è§é—®é¢˜ä¸åˆ†æåœºæ™¯ï¼ˆå¦‚èƒ½æ•ˆã€å¼‚å¸¸ã€è®¾å¤‡å¥åº·ï¼‰ï¼Œå¹¶é€šè¿‡å·¥å†µåˆ†ç±»ï¼ˆèˆ’é€‚/ç‚çƒ­/æ£€ä¿®/æ•…éšœï¼‰å‘ˆç°ï¼Œæ”¯æŒä¸€é”®è·³è½¬è‡³å¯¹åº”åˆ†æè§†å›¾ï¼Œé™ä½æ•°æ®æ¢ç´¢é—¨æ§›ã€‚

## åŠŸèƒ½éœ€æ±‚

### 1. åˆ†ç±»ä½“ç³»

**ä¸€çº§åˆ†ç±»ï¼ˆåˆ†æåœºæ™¯ï¼‰**ï¼š
- èƒ½æ•ˆåˆ†æï¼šç³»ç»Ÿæ•ˆç‡ã€èƒ½è€—è¶‹åŠ¿ã€èŠ‚èƒ½æ½œåŠ›
- å¼‚å¸¸æ£€æµ‹ï¼šæ•°æ®å¼‚å¸¸ã€è®¾å¤‡æ•…éšœã€æ€§èƒ½é€€åŒ–
- è®¾å¤‡å¥åº·ï¼šè¿è¡ŒçŠ¶æ€ã€ç»´æŠ¤å‘¨æœŸã€å¯¿å‘½é¢„æµ‹

**äºŒçº§åˆ†ç±»ï¼ˆå·¥å†µåˆ†ç±»ï¼‰**ï¼š
- èˆ’é€‚ï¼šæ­£å¸¸å·¥ä½œçŠ¶æ€ä¸‹çš„è¿è¡ŒæŒ‡æ ‡
- ç‚çƒ­ï¼šé«˜æ¸©ç¯å¢ƒä¸‹çš„æ€§èƒ½è¡¨ç°
- æ­£å¸¸ï¼šæ ‡å‡†è¿è¡Œå‚æ•°èŒƒå›´
- æ•…éšœï¼šå¼‚å¸¸äº‹ä»¶ä¸æ•…éšœç‰¹å¾
- æ£€ä¿®ï¼šç»´æŠ¤æœŸé—´çš„æ•°æ®ç‰¹å¾

### 2. å¡ç‰‡å¼å±•ç¤º

**åˆ†æåœºæ™¯å¡ç‰‡**ï¼š
| å¡ç‰‡æ ‡é¢˜ | å›¾æ ‡ | æè¿° | å¿«é€Ÿå…¥å£ |
|---------|------|------|---------|
| èƒ½æ•ˆåˆ†æ | ğŸ“Š | åˆ†æç³»ç»Ÿèƒ½æ•ˆæ¯”ä¸èƒ½è€—è¶‹åŠ¿ | æŸ¥çœ‹è¯¦æƒ… |
| å¼‚å¸¸æ£€æµ‹ | âš ï¸ | æ£€æµ‹æ•°æ®å¼‚å¸¸ä¸è®¾å¤‡æ•…éšœ | æŸ¥çœ‹è¯¦æƒ… |
| è®¾å¤‡å¥åº· | ğŸ”§ | ç›‘æ§è®¾å¤‡çŠ¶æ€ä¸ç»´æŠ¤å‘¨æœŸ | æŸ¥çœ‹è¯¦æƒ… |

**å·¥å†µåˆ†ç±»å­å¡ç‰‡**ï¼š
- æ˜¾ç¤ºå·¥å†µåç§°ã€æ•°æ®é‡å æ¯”ã€å¹³å‡æŒ‡æ ‡
- çƒ­åŠ›å›¾/è¿›åº¦æ¡å±•ç¤ºè¯¥å·¥å†µçš„å…³é”®æŒ‡æ ‡åˆ†å¸ƒ
- ç‚¹å‡»è·³è½¬åˆ°å¯¹åº”çš„æ•°æ®æ¢ç´¢è§†å›¾

### 3. æ™ºèƒ½å¯¼èˆª

**å¿«é€Ÿè·³è½¬**ï¼š
- ç‚¹å‡»å¡ç‰‡ â†’ è‡ªåŠ¨é…ç½®æ•°æ®é›†å’Œç­›é€‰æ¡ä»¶
- è‡ªåŠ¨åº”ç”¨å¯¹åº”çš„å¯è§†åŒ–æ¨¡æ¿
- é¢„åŠ è½½å¸¸ç”¨çš„åˆ†æè§†å›¾

**ä¸Šä¸‹æ–‡ä¿æŒ**ï¼š
- è®°å½•ç”¨æˆ·æµè§ˆå†å²
- æ¨èç›¸å…³çš„åˆ†æåœºæ™¯
- æ”¯æŒæ”¶è—å¸¸ç”¨å¡ç‰‡

### 4. ç”¨æˆ·ç•Œé¢

**ä¸»é¢æ¿å¸ƒå±€**ï¼š
- é¡¶éƒ¨æœç´¢æ ï¼šæœç´¢å¡ç‰‡å’Œå·¥å†µ
- å·¦ä¾§åˆ†ç±»æ ‘ï¼šåœºæ™¯åˆ†ç±»å¯¼èˆª
- ä¸­é—´å¡ç‰‡ç½‘æ ¼ï¼šå±•ç¤ºæ‰€æœ‰åˆ†æåœºæ™¯
- å³ä¾§ç»Ÿè®¡é¢æ¿ï¼šå…¨å±€ç»Ÿè®¡ä¸æ¨è

**è¯¦æƒ…è§†å›¾**ï¼š
- åœºæ™¯æ¦‚è§ˆï¼šæ ‡é¢˜ã€æè¿°ã€å…³é”®æŒ‡æ ‡
- å·¥å†µåˆ†å¸ƒï¼šå„å·¥å†µçš„æ•°æ®å æ¯”ä¸è¶‹åŠ¿
- å¿«é€Ÿæ“ä½œï¼šä¸€é”®åˆ†æã€å¯¼å‡ºæŠ¥å‘Šã€è®¾ç½®æé†’

**è®¾ç½®é¢æ¿**ï¼š
- è‡ªå®šä¹‰å¡ç‰‡å¸ƒå±€
- è°ƒæ•´å·¥å†µæ ‡ç­¾
- é…ç½®åˆ†ææ¨¡æ¿

## æ•°æ®ç»“æ„è®¾è®¡

### åˆ†ç±»é…ç½®

```typescript
interface AnalysisCategory {
  id: string;
  name: string;
  icon: string;
  description: string;
  priority: number;
  templates: AnalysisTemplate[];
}

interface AnalysisTemplate {
  id: string;
  name: string;
  description: string;
  datasetId?: string;
  filters: FilterCondition[];
  visualizations: VisualizationConfig[];
  defaultView: 'explore' | 'time-series' | 'comparison';
}

interface FilterCondition {
  field: string;
  operator: 'eq' | 'gt' | 'lt' | 'in' | 'regex';
  value: any;
}

interface VisualizationConfig {
  type: 'scatter' | 'histogram' | 'line' | 'heatmap' | 'bar';
  x?: string;
  y?: string[];
  color?: string;
  aggregation?: 'mean' | 'sum' | 'count';
}
```

### å·¥å†µæ ‡ç­¾

```typescript
interface WorkCondition {
  id: string;
  name: string;
  categoryId: string;
  color: string;
  dataPoints: number;
  percentage: number;
  metrics: {
    avgLoad: number;
    avgCOP: number;
    avgTemp: number;
  };
  filter: FilterCondition[];
}
```

### é¢æ¿é…ç½®

```typescript
interface DashboardConfig {
  layout: 'grid' | 'list' | 'masonry';
  categoryOrder: string[];
  hiddenCards: string[];
  pinnedCards: string[];
  customCards: CustomCard[];
}

interface CustomCard {
  id: string;
  name: string;
  categoryId: string;
  filter: FilterCondition[];
  visualization: VisualizationConfig;
}
```

## API è®¾è®¡

### è·å–åˆ†ç±»ä½“ç³»

```
GET /api/explore/categories

Response:
{
  "categories": [
    {
      "id": "efficiency",
      "name": "èƒ½æ•ˆåˆ†æ",
      "icon": "chart-line",
      "description": "åˆ†æç³»ç»Ÿèƒ½æ•ˆæ¯”ä¸èƒ½è€—è¶‹åŠ¿",
      "priority": 1,
      "templates": [...]
    }
  ]
}
```

### è·å–å·¥å†µç»Ÿè®¡

```
GET /api/explore/work-conditions?categoryId={categoryId}

Response:
{
  "categoryId": "efficiency",
  "conditions": [
    {
      "id": "comfort",
      "name": "èˆ’é€‚",
      "color": "#10B981",
      "dataPoints": 1520,
      "percentage": 65,
      "metrics": { ... },
      "filter": [...]
    }
  ]
}
```

### è·å–åˆ†ææ¨¡æ¿

```
GET /api/explore/templates/:templateId

Response:
{
  "id": "efficiency-trend",
  "name": "èƒ½æ•ˆè¶‹åŠ¿åˆ†æ",
  "datasetId": "ds-001",
  "filters": [...],
  "visualizations": [...],
  "defaultView": "time-series"
}
```

### ä¿å­˜é¢æ¿é…ç½®

```
PUT /api/explore/dashboard/config
Body: DashboardConfig
Response: { success: true }
```

### åˆ›å»ºè‡ªå®šä¹‰å¡ç‰‡

```
POST /api/explore/custom-cards
Body: { name, categoryId, filter, visualization }
Response: { cardId: "custom-001" }
```

## å‰ç«¯å®ç°è¦ç‚¹

### 1. ä¸»é¢æ¿ç»„ä»¶

```typescript
const SmartExploreDashboard: React.FC = () => {
  const [categories, setCategories] = useState<AnalysisCategory[]>([]);
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [layout, setLayout] = useState<'grid' | 'list'>('grid');
  const [searchQuery, setSearchQuery] = useState('');

  const filteredCategories = useMemo(() => {
    return categories.filter(cat =>
      cat.name.includes(searchQuery) ||
      cat.description.includes(searchQuery)
    );
  }, [categories, searchQuery]);

  return (
    <div className="explore-dashboard">
      <SearchBar query={searchQuery} onChange={setSearchQuery} />
      <LayoutToggle layout={layout} onChange={setLayout} />

      <div className="dashboard-content">
        <CategoryTree
          categories={categories}
          selected={selectedCategory}
          onSelect={setSelectedCategory}
        />
        <CategoryCardsGrid
          categories={filteredCategories}
          layout={layout}
          onSelect={handleCardSelect}
        />
        <StatisticsPanel categories={categories} />
      </div>
    </div>
  );
};
```

### 2. åˆ†ç±»å¡ç‰‡ç»„ä»¶

```typescript
const CategoryCard: React.FC<{ category: AnalysisCategory; onSelect }> = ({ category, onSelect }) => {
  const [conditions, setConditions] = useState<WorkCondition[]>([]);

  useEffect(() => {
    api.explore.workConditions(category.id).then(setConditions);
  }, [category.id]);

  return (
    <Card className="category-card" onClick={() => onSelect(category)}>
      <div className="card-header">
        <Icon name={category.icon} />
        <h3>{category.name}</h3>
      </div>
      <p className="card-description">{category.description}</p>

      <div className="work-conditions">
        {conditions.map(condition => (
          <ConditionBadge key={condition.id} condition={condition} />
        ))}
      </div>

      <div className="card-actions">
        <Button variant="primary">æŸ¥çœ‹è¯¦æƒ…</Button>
        <Button variant="secondary">é…ç½®æ¨¡æ¿</Button>
      </div>
    </Card>
  );
};
```

### 3. å·¥å†µåˆ†å¸ƒå›¾

```typescript
const ConditionDistributionChart: React.FC<{ conditions: WorkCondition[] }> = ({ conditions }) => {
  const data = {
    labels: conditions.map(c => c.name),
    datasets: [{
      data: conditions.map(c => c.percentage),
      backgroundColor: conditions.map(c => c.color),
      borderWidth: 0,
    }]
  };

  return (
    <div className="condition-distribution">
      <Doughnut data={data} options={doughnutOptions} />
      <Legend items={conditions.map(c => ({
        label: c.name,
        value: `${c.percentage}%`,
        color: c.color
      }))} />
    </div>
  );
};
```

## åç«¯å®ç°è¦ç‚¹

### 1. å·¥å†µè¯†åˆ«å¼•æ“

```python
class WorkConditionClassifier:
    def __init__(self, condition_rules: List[Dict]):
        self.rules = condition_rules

    def classify(self, data: pd.DataFrame) -> pd.DataFrame:
        """
        æ ¹æ®è§„åˆ™å¯¹æ•°æ®è¿›è¡Œå·¥å†µåˆ†ç±»
        """
        results = data.copy()
        results['condition_id'] = 'normal'

        for rule in self.rules:
            mask = self._apply_rule(data, rule['filter'])
            results.loc[mask, 'condition_id'] = rule['id']

        return results

    def _apply_rule(self, data: pd.DataFrame, filter_config: Dict) -> pd.Series:
        """
        åº”ç”¨ç­›é€‰æ¡ä»¶
        """
        mask = pd.Series([True] * len(data))

        for condition in filter_config:
            if condition['operator'] == 'gt':
                mask &= data[condition['field']] > condition['value']
            elif condition['operator'] == 'lt':
                mask &= data[condition['field']] < condition['value']
            elif condition['operator'] == 'in':
                mask &= data[condition['field']].isin(condition['value'])
            elif condition['operator'] == 'regex':
                mask &= data[condition['field']].str.match(condition['value'])

        return mask

    def get_statistics(self, classified_data: pd.DataFrame) -> List[Dict]:
        """
        è®¡ç®—å„å·¥å†µçš„ç»Ÿè®¡ä¿¡æ¯
        """
        stats = []

        for condition_id in classified_data['condition_id'].unique():
            condition_data = classified_data[classified_data['condition_id'] == condition_id]

            stats.append({
                'id': condition_id,
                'dataPoints': len(condition_data),
                'percentage': len(condition_data) / len(classified_data) * 100,
                'metrics': {
                    'avgLoad': condition_data['load_total'].mean(),
                    'avgCOP': condition_data['cop_avg'].mean(),
                    'avgTemp': condition_data['temp_avg'].mean(),
                }
            })

        return stats
```

### 2. æ¨¡æ¿ç®¡ç†æœåŠ¡

```python
class TemplateService:
    def __init__(self, template_repo: TemplateRepository):
        self.repo = template_repo

    def get_template(self, template_id: str) -> Dict:
        """
        è·å–åˆ†ææ¨¡æ¿
        """
        template = self.repo.find_by_id(template_id)

        # åº”ç”¨æ¨¡æ¿åˆ°æ•°æ®é›†
        if template['datasetId']:
            data = self._load_dataset(template['datasetId'])
            filtered_data = self._apply_filters(data, template['filters'])
            visualizations = self._generate_visualizations(
                filtered_data,
                template['visualizations']
            )

            return {
                **template,
                'preview': {
                    'data': filtered_data.head(100).to_dict('records'),
                    'visualizations': visualizations
                }
            }

        return template

    def _apply_filters(self, data: pd.DataFrame, filters: List[Dict]) -> pd.DataFrame:
        """
        åº”ç”¨ç­›é€‰æ¡ä»¶
        """
        filtered_data = data.copy()

        for filter_config in filters:
            if filter_config['operator'] == 'eq':
                filtered_data = filtered_data[filtered_data[filter_config['field']] == filter_config['value']]
            elif filter_config['operator'] == 'gt':
                filtered_data = filtered_data[filtered_data[filter_config['field']] > filter_config['value']]
            # ... å…¶ä»–æ“ä½œç¬¦

        return filtered_data

    def _generate_visualizations(self, data: pd.DataFrame,
                                  configs: List[Dict]) -> List[Dict]:
        """
        ç”Ÿæˆå¯è§†åŒ–é…ç½®
        """
        visualizations = []

        for config in configs:
            if config['type'] == 'scatter':
                viz_data = {
                    'x': data[config['x']].tolist(),
                    'y': [data[col].tolist() for col in config['y']],
                    'color': data[config['color']].tolist() if config.get('color') else None
                }
                visualizations.append({ **config, 'data': viz_data })

            elif config['type'] == 'histogram':
                viz_data = {
                    'values': data[config['y'][0]].tolist(),
                    'bins': config.get('bins', 20)
                }
                visualizations.append({ **config, 'data': viz_data })

        return visualizations
```

## éªŒæ”¶æ ‡å‡†

1. åˆ†ç±»å¼æ™ºèƒ½æ¢ç´¢é¢æ¿å±•ç¤ºæ‰€æœ‰åˆ†æåœºæ™¯å¡ç‰‡
2. å¡ç‰‡ç‚¹å‡»åè‡ªåŠ¨é…ç½®ç­›é€‰æ¡ä»¶å¹¶è·³è½¬åˆ°å¯¹åº”åˆ†æè§†å›¾
3. å·¥å†µåˆ†ç±»å‡†ç¡®ï¼Œæ•°æ®å æ¯”è®¡ç®—æ­£ç¡®
4. æ”¯æŒå¿«é€Ÿæœç´¢å¡ç‰‡å’Œå·¥å†µ
5. å¯è‡ªå®šä¹‰å¡ç‰‡å¸ƒå±€å’Œéšè—ä¸å¸¸ç”¨å¡ç‰‡
6. æ”¯æŒåˆ›å»ºè‡ªå®šä¹‰å¡ç‰‡å¹¶ä¿å­˜ç­›é€‰æ¡ä»¶
7. å“åº”æ—¶é—´ < 1 ç§’ï¼ˆåŠ è½½é¢æ¿ï¼‰
8. æ”¯æŒæ•°æ®é›†çº§åˆ«çš„å·¥å†µæ ‡ç­¾é…ç½®
