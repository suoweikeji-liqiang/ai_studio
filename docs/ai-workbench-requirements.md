# 暖通 AI 工作台需求说明

## 1. 背景与目标
- 暖通物联网平台已管理多项目、多系统设备，需要新增 AI 工作台以支撑负荷预测、故障诊断、节能控制等模型全生命周期。（ref/M1原型落地实施计划（探索_特征_训练WS_结果后处理）.md:1-10）
- 目标是提供一站式机器学习工程平台，覆盖数据准备→特征→训练→部署→推理，并与现有 IoT 设备模型和实时数据无缝集成，支持大模型智能问数。（ref/user prompt sections 1.1-1.3）

## 2. 角色与典型场景
- 数据科学家：构建特征计划、训练模型、查看实验指标。
- 工程实施/运维：管理数据流水线、监控训练作业、部署与发布 API。
- 业务运营：通过模板化模型与智能问数功能，快速获取能效/故障洞察。

## 3. 范围概览
| 模块 | 核心能力 |
| --- | --- |
| 数据管理 | 元数据模板编辑、数据流水线/数据集管理、导出与再加工。（ref/M1.1 业务流程补全与交互优化方案.md:13-33, ref/数据流水线.tsx:15-199）|
| 特征工程 | 手工/自动特征计划、默认填充策略、组合过滤、公式算子、计划保存与复用。（ref/M1.1 业务流程补全与交互优化方案.md:30-39）|
| 训练与评估 | 训练作业管理、WS 事件统一、评估摘要/模型卡生成。（ref/M1原型落地实施计划（探索_特征_训练WS_结果后处理）.md:20-24）|
| 注册与部署 | 模型注册、版本管理、部署映射、API 调用示例。（ref/M1原型落地实施计划（探索_特征_训练WS_结果后处理）.md:25-56）|
| 推理与后处理 | 输入合法化（单位/时间/缺失）、标准输出结构、错误格式规范。（ref/M1原型落地实施计划（探索_特征_训练WS_结果后处理）.md:33-43）|
| 智能问数 | 基于行业语义层与大模型的问答、报表生成（高阶目标，需进一步细化）。

## 4. 功能需求细化
### 4.1 元数据与数据集
1. 元数据模板编辑：
   - 编辑弹窗需支持字段表格（增删/名称/编码/类型/单位）、AI 识别批量导入、key 唯一校验。（ref/M1.1 业务流程补全与交互优化方案.md:14-21）
2. 数据集管理：
   - 新增 `DatasetsPage` 显示名称/行数/时间窗/状态/Schema/处理步骤/创建时间，提供“查看/编辑/导出/再加工”。
   - 详情抽屉可预览前 10 行、展示处理步骤时间线、Schema 关联。
   - “再加工”可预填构建器参数生成新版本；导出提供 CSV 下载。（ref/M1.1 业务流程补全与交互优化方案.md:23-29）
3. 数据流水线/导出模板：
   - 支持 Raw 与 Aggregate 两种模式、项目/设备/指标层级筛选、标签过滤、字段映射到标准 Schema，并生成 SQL。（ref/数据集构造器.tsx:131-358, ref/数据流水线.tsx:15-195, ref/数据导出模板.tsx:50-220）
   - 记录调度配置、执行记录（rowCount、文件大小、执行人）与模板版本。 

### 4.2 特征工程
1. 默认填充策略：全局与按字段配置 ForwardFill/Zero/Mean/Median/Custom，写入特征计划。（ref/M1.1 业务流程补全与交互优化方案.md:30-33）
2. 组合过滤：AND/OR 条件、阈值/区间/字符串匹配，支持可视化条件列表与撤销。（ref/M1.1 业务流程补全与交互优化方案.md:32-33）
3. 公式表达式：
   - 内置函数 `lag`, `rolling`, `diff`, `zscore`, `poly`，生成新特征列；需要安全解析器避免任意执行。（ref/M1.1 业务流程补全与交互优化方案.md:33-38）
4. 计划保存与复用：特征页可保存/加载计划，探索页“一键加入特征计划”；提供预览与成本评分。（ref/M1.1 业务流程补全与交互优化方案.md:37-39, ref/数据探索.tsx:20-195）

### 4.3 数据探索与洞察
1. 通用探索：散点、直方、箱线、回归分析、聚类等视图，输出建议特征可加入计划。（ref/数据探索.tsx:18-195）
2. 时序探索：
   - 趋势+季节性预测、滑动 Z-Score 异常检测、周/日模式对比、置信区间展示。
   - 可导出洞察报告或截图。（ref/数据探索_时序增强版.tsx:23-199）

### 4.4 训练、注册与部署
1. 训练作业：
   - `POST /api/training/jobs` 启动作业，WS `/ws` 推送 `log|metric|artifact|done|error`，前端需根据统一事件更新 UI，并展示 MAE/MAPE/分位误差。（ref/M1原型落地实施计划（探索_特征_训练WS_结果后处理）.md:20-24,45-54）
2. 模型注册与版本管理：
   - 成功训练后可“一键注册→发布”，记录 dataset snapshot、time range、指标、artifact、部署信息。（ref/AI模型管理.tsx:828-900）
   - 列表需支持构建模式（Template/Script/Custom Image/Import）、数据绑定、调度配置、版本 Promote/回滚。（ref/AI模型管理.tsx:396-900, ref/AI模型管理可配置.tsx:74-190）
3. 部署与映射：
   - `POST /api/deployments` 创建服务，`PUT /api/deployments/:id/mapping` 保存输入字段映射和单位。
   - 发布页展示 `apiUrl`/`apiToken`，提供 curl/Python 示例及标准输出样例。（ref/M1原型落地实施计划（探索_特征_训练WS_结果后处理）.md:25-56）

### 4.5 推理与结果后处理
1. 输入校验：字段齐备、单位统一（kW→W、°C→K 等）、采样间隔校验+插值、缺失阈值告警，超阈返回 `INPUT_MISSING_EXCEEDS`。（ref/M1原型落地实施计划（探索_特征_训练WS_结果后处理）.md:33-39）
2. 标准输出：`{ modelId, version, timestamp, values:[{t,y}], unit, intervals:{p05,p50,p95}, confidence, warnings, meta:{datasetId, featurePlanId} }`。（ref/M1原型落地实施计划（探索_特征_训练WS_结果后处理）.md:40-43）
3. 错误格式统一 `{ code, message, details }`，涵盖 `INVALID_INPUT`, `UNIT_INCONSISTENT`, `INPUT_MISSING_EXCEEDS`, `INFERENCE_FAILED`。（同上）

### 4.6 智能问数与助手（待细化）
- 基于数据语义层和大模型，实现面向运维人员的自然语言问答与图文并茂报表（文字描述 + 图表/指标卡），支持一键导出；需要明确语料来源、权限控制及响应 SLA。（ref/AI模型管理.tsx:420-735 的 Copilot 交互可复用）

## 5. 接口与契约
- 后端需提供 Explore / Features / Training / Registry / Deployments / Inference 六类 REST + WS 接口，契约通过新建的 `FeaturePlan.schema.json`, `InferenceInput.schema.json`, `InferenceOutput.schema.json`, `Error.schema.json` 固化并在前端校验。（ref/M1原型落地实施计划（探索_特征_训练WS_结果后处理）.md:12-60）
- 事件协议：`log|metric|artifact|done|error`，前端需实现与旧事件的适配层（如有）。 （ref/M1.1 业务流程补全与交互优化方案.md:40-43）

## 6. 技术与工程治理
- Git 策略：`main` 只收里程碑，特征/训练/伙伴集成分支独立，首个提交及 tag 已完成；建议启用 lint/TS pre-commit 和可选 commitlint。（ref/AI模型中心平台强化方案.md:1-27）
- 工件管理：训练模型保存在 `artifacts/`（不入库），重要合并点需记录 release note 和工件路径。（ref/AI模型中心平台强化方案.md:20-27）
- 训练资源：暂未指定，优先考虑以 Airflow 调度 + MLflow 跟踪的组合；自定义镜像与脚本运行暂不需要审批流程，可直接由工程团队配置。

## 7. 里程碑建议（M1-M3）
1. **M1：探索→特征→训练闭环**
   - 定义契约 & 结果格式 → Explore/Features/Training/WS 最小实现 → 前端探索与特征联动 → 训练页接入 WS 与注册发布 → 部署页输入映射与推理演示。（ref/M1原型落地实施计划（探索_特征_训练WS_结果后处理）.md:66-71）
2. **M1.1 补强**：元数据编辑、数据集管理、特征算子扩展、事件统一。（ref/M1.1 业务流程补全与交互优化方案.md:13-58）
3. **后续 M2/M3 方向（待细化）**：行业模板沉淀（优先交付负荷预测模板）、AutoML/大模型问数、策略闭环、成本/能效分析。

## 8. 验收指标（示例）
- 模型上线周期较现状缩短 ≥30%，预测/告警精度达业务阈值。
- 自动化覆盖率：自动特征、自动部署功能可支撑 ≥3 个项目复用。
- IoT 平台集成效率：跨系统集成工单/工时降低 ≥40%。
- 推理接口符合标准输出/错误规范，抽检 100% 通过。

## 9. 决策更新 & 待办
- 智能问数：输出需同时包含文字与图表，主要服务运维人员。
- 数据契约：所有 JSON Schema 可新建，后续在仓库维护。
- 训练资源：尚未落地，优先考虑 Airflow + MLflow；自定义镜像/脚本无需审批。
- 单位/时间字典：当前无企业级标准，需要在项目内定义最小集合。
- 行业模板：首个重点为负荷预测，其他模板可后续排期。

> 当前暂无额外阻塞问题，可在规划 M1 任务时按上述决策执行；若引入企业字典或其他模板优先级发生变化，再追加说明。
